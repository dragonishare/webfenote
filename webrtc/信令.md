webRTC支持点对点通讯，但是webRTC仍然需要服务端：

* 协调通讯过程中客户端之间需要交换元数据，如一个客户端找到另一个客户端以及通知另一个客户端开始通讯。
* 需要处理NAT（网络地址转换）或防火墙，这是公网上通讯首要处理的问题。所以我们需要了解服务端相关的知识：信令、Stun、trun、ice。

## 什么是信令

信令就是协调通讯的过程，为了建立一个webRTC的通讯过程，客户端需要交换如下信息：

* 会话控制信息，用来开始和结束通话，即开始视频、结束视频这些操作指令。
* 处理错误的消息。
* 元数据，如各自的音视频解码方式、带宽。
* 网络数据，对方的公网IP、端口、内网IP及端口。



信令处理过程需要客户端能够来回传递消息，这个过程在webRTC里面是没有实现的，需要自己创建。
一旦信令服务建立好了,两个客户端之间建立了连接,理论上他们就可以进行点对点通讯了,
这样可以减轻信令服务的压力和消息传递的延迟。

因为信令是我们自己定义的,所以安全性问题跟webrtc无关,需要自己处理。
一旦黑客掌握了你的信令,那他就是控制会话的开始、结束、重定向等等。
最重要的因素在信令安全中还是要靠使用安全协议,如HTTPS,WSS(如TLS),
他们能确保未加密的消息不能被截取。为确保信令安全,强烈推荐使用TLS。

## TURN 和 STUN

元数据是通过信令服务器中转发给另一个客户端,但是对于流媒体数据,一旦会话建立,首先尝试使用点对点连接。
简单一点说就是:   每个客户端都有一个唯一的地址,他能用来和其他客户端进行通讯和数据交换。

现实生活中客户端都位于一个或多个NAT之后,或者一些杀毒软件还阻止了某些端口和协议,
或者在公司还有防火墙或代理等等,防火墙和NAT或许是同一个设备,如我们家里用的路由器。

webrtc就是通过 ICE 这套框架来处理复杂的网络环境的,
如果想启用这个功能,你必须让你的应用程序传 ICE 服务器的URL：

* ICE试着找最好的路径来让客户端建立连接,他会尝试所有可能的选项,然后选择最合适的方案
* ICE首先尝试P2P连接,如果失败就会通过Turn服务器进行转接。

换一个说法就是:

* STUN服务器是用来取外网地址的。
* TURN服务器是在P2P失败时进行转发的

stun和turn服务的作用主要处理打洞与转发，配合完成ICE协议。
首先尝试使用P2P，
如果失败将求助于TCP，使用turn转发两个端点的音视频数据，turn转发的是两个端点之间的音视频数据不是信令数据。
因为turn服务器是在公网上，所以他能被各个客户端找到，
另外turn服务器转发的是数据流，很占用带宽和资源。

## ICE技术

基于IP的语音、数据、视频等业务在NGN（Next Generation Network）网络中
所面临的一个实际困难就是如何有效地穿透各种NAT（Network Address Translator）/FW(Fire Wall)的问题。
对此，SIP（会话初始化协议）以往的解决方法由ALGs（(Application Layer Gateway Service)）、STUN、TURN等方式。

现在有一种新的媒体会话信令穿透NAT/FW的解决方案-交互式连通建立方式ICE。
它通过综合利用现有协议，以一种更有效的方式来组织会话建立过程，
使之在不增加任何延迟同时比STUN等单一协议更具有健壮性、灵活性。
多媒体会话信令协议是在准备建立媒体流传输的代理之间交互信息的协议，
例如SIP、RTSP（real time streaming protocol）等。

媒体流与信令流截然不同，它们所采用的网络通道也不一致。
由于协议自身设计上的原因，使得媒体流无法直接穿透网络地址转换/防火墙(NAT/FW)。
因为它们生存期的目标只是为了建立一个在信息中携带IP地址的分组流，这在遇到NAT/FW 时会带来许多问题。
而且这些协议的目标是通过建立P2P(Peer to Peer)媒体流以减小时延，而协议本身很多方面却与NAT存在兼容性问题，
这也是穿透 NAT/FW的困难所在。

## ICE简介

交互式连通建立方式ICE(Interactive Connectivity Establishment)并非一种新的协议，
它不需要对STUN、TURN或RSIP进行扩展就可适用于各种NAT。

ICE是通过综合运用上面某几种协议，使之在最适合的情况下工作，以弥补单独使用其中任何一种所带来的固有缺陷。
对于SIP来说，ICE只需要定义一些SDP(Session Description Protocol)附加属性即可，
对于别的多媒体信令协议也需要制定一些相应的机制来实现。

## 多媒体信令

媒体流穿透NAT的过程是独立于某种具体的信令协议的。
通信发生在两个客户端－会话发起者和会话响应者。
初始化信息(Initiate Message)包含了描述会话发起者媒体流的配置与特征，
并经过信令调停者(也叫信令中继)，最后到达会话响应者。

媒体流穿透NAT的过程是独立于某种具体的信令协议的。
通信发生在两个客户端－会话发起者和会话响应者。
初始化信息(Initiate Message)包含了描述会话发起者媒体流的配置与特征，
并经过信令调停者(也叫信令中继)，最后到达会话响应者。

假设会话响应者同意通信，接受信息(Accept Message)将产生并反馈至会话初始者，媒体流建立成功。
此外，信令协议还对媒体流参数修改以及会话终止消息等提供支持。
对于SIP，会话发起者即UAC(User Agent Client)，会话响应者即UAS(User Agent Server)，
初始化消息对应SDP请求里面的INVITE，接受消息对应于SDP应答里面的200 OK，终止消息对应于BYE。



## WebRTC 三种类型信令消息的控制与交换

信令服务器用于交换三种类型的信息：

- 会话控制消息：初始化/关闭，各种业务逻辑消息以及错误报告。
- 网络相关：外部可以识别的IP地址和端口。
- 媒体能力：客户端能控制的编解码器、分辩率，以及它想与谁通讯。

### 网络信息消息

网络信息消息用于两个客户端之间交换网络信息。在WebRTC中使用 ICE 机制建立网络连接。

在WebRTC的每一端，当创建好 RTCPeerConnection 对象，且调用了setLocalDescription 方法后，就开始收集 **ICE候选者** 了。

在WebRTC中有三种类型的**候选者**，它们分别是：

- 主机候选者
- 反射候选者
- 中继候选者

**主机候选者**，表示的是本地局域网内的 IP 地址及端口。它是三个候选者中优先级最高的，也就是说在 WebRTC 底层，首先会偿试本地局域网内建立连接。

**反射候选者**，表示的是获取 NAT 内主机的外网IP地址和端口。其优先级低于 **主机候选者**。也就是说当WebRTC偿试本地连接不通时，会偿试通过**反射候选者**获得的 IP地址和端口进行连接。

**中继候选者**，表示的是中继服务器的IP地址与端口，即通过服务器中转媒体数据。当WebRTC客户端通信双方无法穿越 P2P NAT 时，为了保证双方可以正常通讯，此时只能通过服务器中转来保证服务质量了。

所以 **中继候选者**的优先级是最低的，只有上述两种候选者都无法进行连接时，才会使用它。

### 交换媒体能力消息

在WebRTC中，媒体能力最终通过 SDP 呈现。在传输媒体数据之前，首先要进行媒体能力协商，看双方都支持那些编码方式，支持哪些分辨率等。协商的方法是通过信令服务器交换媒体能力信息。





